# ESP32-CAM 轻量监控系统需求文档
**版本**：v2.0  
**日期**：2025-10-16  
**修改记录**：  
- v1.0（2025-10-05）：完成局域网实时视频核心功能开发，实现基于ESP32-CAM的HTTP视频流服务，支持VGA等分辨率和基本的WiFi连接功能
- v1.1（2025-10-10）：深入研究ESP32-CAM硬件特性，优化内存管理策略，解决Flash容量限制问题，规范项目目录结构，分离前端（miniprogram）和后端（esp32cam-firmware）代码，为后续功能扩展奠定基础
- v2.0（2025-10-16）：架构升级，引入MQTT通信机制，设计微信小程序与ESP32-CAM的多通道通信架构，明确HTTP、MQTT和WebSocket在系统中的职责分工，支持远程控制和图像传输功能

## 1. 项目概述
### 1.1 项目背景与意义
当前校园和租房场景中，轻量监控需求（如查看实验室3D打印机状态、租房内安全情况）逐渐增加，但商用监控设备存在成本高（需额外购买硬件和云服务）、部署复杂的问题。  
本项目基于ESP32-CAM开发板（已有的硬件资源，无额外成本），实现低成本、易部署的远程监控系统，支持局域网实时查看和公网访问，既能满足实际监控需求，又能积累嵌入式开发（硬件驱动+网络通信）的实战经验，为实习简历补充完整项目案例。

### 1.2 目标用户与场景
| 目标用户       | 核心使用场景                                                                 |
|----------------|------------------------------------------------------------------------------|
| 学生群体       | 宿舍安防（远程查看是否有陌生人进入）、实验室设备监控（如3D打印机是否完成打印） |
| 租房用户       | 出门后通过手机查看家中门窗状态、宠物活动（无需复杂配置，连接WiFi即可使用）     |
| 嵌入式学习者   | 作为实战案例，掌握ESP32外设驱动（摄像头、WiFi）、HTTP视频流、内网穿透等技术   |

### 1.3 项目目标
基于 ESP32-CAM 成品板（OV2640 摄像头、5V USB 供电），开发支持局域网实时监控 + 外网访问（内网穿透）+MQTT 远程控制的嵌入式系统，满足 "短期调试 / 轻量演示" 需求，适配 ESP-IDF v5.5 开发环境，确保功能可落地、文档可追溯。

### 1.4 硬件规格
#### 1.4.1 ESP32-CAM 模块核心参数
| 特性 | 详情 |
|------|------|
| 处理器 | 双核240MHz ESP32，支持蓝牙4.2 + BLE |
| 存储配置 | 4MB SPI Flash + 520kB SRAM + 4MB PSRAM |
| WiFi性能 | 2.4GHz频段，支持802.11b/g/n |
| 功耗控制 | Deep-sleep模式最低6mA |
| 扩展接口 | 支持TF卡(最大4GB)、UART/SPI/I2C等 |
| 供电要求 | 4.75-5.25V，≥1A电源适配器 |

#### 1.4.2 OV2640 摄像头核心参数
| 特性 | 详情 |
|------|------|
| 最高分辨率 | UXGA(1600×1200)@15fps |
| 主流配置 | SVGA(800×600) / VGA(640×480) |
| 最大帧率 | UXGA(1600*1200)@15帧；SVGA(800*600)@30帧；CIF(352*288)@60帧 |
| 输出格式 | 支持JPEG/RGB/YUV等，本项目用JPEG优化传输 |

## 2. 功能需求
### 2.1 核心功能（必须实现）
| 功能模块         | 具体需求描述（要可操作、可验证）                                                                 |
|------------------|-------------------------------------------------------------------------------------------------|
| 摄像头视频采集   | 1. 适配OV2640摄像头，输出JPEG格式视频流（方便网络传输）；<br>2. 分辨率固定为640x480（VGA，平衡清晰度和带宽）；<br>3. 帧率≥30fps（保证画面流畅）；<br>4. 初始化失败时，串口打印错误日志（如"camera init failed: timeout"）。 |
| WiFi连接管理     | 1. 支持STA模式，连接指定WiFi（SSID和密码可在代码中配置）；<br>2. 断连后自动重连（最多重试5次，间隔3秒/次）；<br>3. 连接成功后，串口打印局域网IP（如"IP: 192.168.1.100"）。 |
| HTTP视频服务     | 1. 启动HTTP服务器（默认端口8080）；<br>2. 浏览器访问`http://IP地址`时，能实时显示视频流；<br>3. 支持至少1台设备查看（当前限制，后续可扩展）。 |
| MQTT通信         | 1. ESP32-CAM作为MQTT客户端连接EMQX服务器；<br>2. 支持接收控制指令（拍照、开始/停止视频流）；<br>3. 支持发送单张图片数据。 |

### 2.2 扩展功能（后续版本可追加，）
| 功能模块         | 具体需求描述                                                                 |
|------------------|------------------------------------------------------------------------------|
| 内网穿透         | 通过 Ngork 或 Sakura Frp工具，实现公网访问视频流                |
| 远程截图         | 访问`http://IP地址/snapshot`时，保存当前画面为JPEG图片（存到TF卡）           |
| MQTT控制         | 接收"开启/关闭摄像头"指令（通过MQTT协议），关闭时降低功耗                     |
| 微信小程序       | 开发配套小程序客户端，通过MQTT协议连接ESP32-CAM，支持视频流查看、截图指令发送 |

## 3. 性能需求 具体怎么测量，万用表、示波器等工具
| 性能指标         | 目标值（可实现、可测试）                          | 测试方法（怎么验证达标）                                                                 |
|------------------|---------------------------------------------------|----------------------------------------------------------------------------------------|
| 视频延迟         | 局域网内≤1秒，公网（扩展后）≤3秒                  | 用手机拍摄ESP32摄像头画面，同时在浏览器看视频，对比两者的时间差                           |
| 稳定性           | 连续运行≥24小时无崩溃、无断流                     | 通电后持续运行24小时，检查串口日志无异常重启，浏览器画面无中断                           |
| 内存占用         | 单帧JPEG数据≤100KB（避免PSRAM不足）               | 代码中打印每帧数据大小，连续100帧均不超过100KB                                          |
| 功耗（扩展）     | 摄像头工作时电流≤200mA，关闭时≤50mA               | 用万用表串联在供电回路中，测量不同状态下的电流值                                         |

## 4. 约束条件
### 4.1 硬件限制
| 硬件参数         | 限制描述                                                                 | 应对措施（体现解决问题的思路）                                                       |
|------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------------------|
| ESP32 - CAM资源  | CPU：双核240MHz（算力有限）； 内存：520KB内部RAM + 4M PSRAM； spi flash 4MB              | 1. 用PSRAM存储视频帧（不占用内部RAM）；<br>2. 单线程处理视频流（避免多任务切换开销） |
| 摄像头供电       | OV2640工作时峰值电流≥150mA，电脑USB口供电可能不足                         | 必须用≥1A的电源适配器供电（避免初始化失败）                                           |

### 4.2 网络限制
| 网络条件         | 限制描述                                                                 | 应对措施                                                                             |
|------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------------------|
| WiFi频段         | ESP32仅支持2.4GHz（不支持5GHz）                                          | 连接WiFi时需选择2.4GHz热点                                                           |
| 公网带宽（扩展） | 免费内网穿透工具（如Sakura Frp）带宽≤1Mbps                               | 降低视频帧率至5fps（平衡流畅度和带宽）                                                |

### 4.3 成本限制
- 无额外硬件支出：基于现有ESP32-CAM开发板，不购买新传感器或服务器；
- 软件工具免费：使用ESP-IDF（开源）、免费内网穿透工具、公共MQTT服务器。

## 5. 系统通信架构

### 通信方式分工

#### HTTP通信
- 用途：传输实时视频流
- 数据方向：ESP32-CAM → 小程序（单向）
- 数据格式：连续JPEG帧
- 传输方式：HTTP multipart流
- 端口：8080（或其他指定端口）

#### MQTT通信
- 用途：传输控制命令和单张图片
- 数据方向：双向通信
- 控制命令：ESP32-CAM ← 小程序
  - take_picture：拍照指令
  - start_stream：开始视频流传输
  - stop_stream：停止视频流传输
- 图片数据：ESP32-CAM → 小程序
  - 单张图片数据（拍照结果）
- 传输方式：MQTT over TCP（ESP32-CAM）和MQTT over WebSocket（小程序）

#### WebSocket通信
- 用途：小程序连接MQTT服务器
- 数据方向：双向
- 端口：8083（EMQX WebSocket端口）

### 需要考虑的问题
1. 系统架构问题
- 如何协调三种通信方式，避免冲突
- 数据流和控制流的分离
- 系统资源的合理分配
2. 微信小程序限制
- 域名白名单配置
- WebSocket连接限制
- 图像数据处理性能
- MQTT.js版本兼容性问题（不同版本可能存在API差异或平台适配问题）
3. ESP32资源管理
- 内存管理（特别是图像数据）
- 任务调度和优先级
- WiFi连接稳定性
- ESP-MQTT版本兼容问题
4. 用户体验
- 视频流的延迟和流畅度
- 控制指令的响应速度
- 界面的友好性
- 系统连接的稳定性和错误处理