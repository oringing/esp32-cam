# ESP32-CAM 远程监控系统需求文档（2025/10/05第1版）
## 1. 项目目标  
基于ESP32-CAM成品板（OV2640摄像头、5V USB供电），开发一款**支持局域网实时监控+外网访问（内网穿透）+MQTT远程控制**的嵌入式系统，满足“短期调试/轻量演示”需求（如宿舍监控、3D打印机状态查看），同时适配ESP-IDF v5.5开发环境，确保功能可落地、文档可追溯。


## 2. 项目边界（范围）
### 2.1 纳入范围
- **硬件支持**：  
  - ESP32-CAM成品板（双核32位CPU 240MHz，520KB SRAM+8MB PSRAM，CH340串口芯片）；  
  - 外设：OV2640摄像头（默认搭载）、Micro-USB供电（≥1A）、TF卡（可选，FAT32格式）；  
  - 接口：仅启用项目必需的UART（调试）、SPI（PSRAM）、I2C（摄像头控制）接口。  
- **核心功能**：  
  - 视频采集：OV2640输出JPEG格式视频流（VGA 640x480分辨率，10fps帧率）；  
  - 网络通信：WiFi STA模式（连接外网）、HTTP视频流推送（局域网访问）；  
  - 外网访问：基于Sakura Frp/花生壳实现内网穿透（TCP端口映射）；  
  - MQTT控制：支持远程截图、摄像头开关、视频流帧率调整；  
  - 基础保障：WiFi自动重连（重试5次）、摄像头初始化失败告警（串口日志）。  
- **开发适配**：  
  - 环境：ESP-IDF v5.5（兼容VSCode插件）；  
  - 依赖组件：`esp32-camera`（摄像头驱动）、`esp_http_server`（HTTP服务）、`mqtt_client`（MQTT客户端）。  

### 2.2 排除范围
- 不支持非OV2640摄像头（如OV7670需额外适配，不在短期需求内）；  
- 不支持高分辨率视频流（如1080P，受免费内网穿透带宽/PSRAM限制）；  
- 不包含复杂存储功能（如TF卡循环录像，仅支持单次截图存储）；  
- 不涉及HTTPS加密（免费穿透工具暂不支持，短期调试用HTTP）。


## 3. 功能需求（补充核心场景，细化可落地细节）
| 功能模块         | 具体需求描述                                                                 |
|------------------|------------------------------------------------------------------------------|
| 1. 摄像头采集    | 1. 初始化OV2640摄像头，输出JPEG格式视频流（分辨率640x480/VGA，帧率10fps）；<br>2. 支持JPEG质量调整（参数30-50，默认30，平衡清晰度与内存）；<br>3. 采集异常时（如无帧数据），串口输出告警日志（TAG：camera_err）。 |
| 2. WiFi网络      | 1. 支持STA模式连接指定WiFi（SSID/密码可配置），断连后30秒内自动重试（最多5次）；<br>2. 连接成功后，串口打印ESP32局域网IP（如192.168.1.105）；<br>3. 重连5次失败后，触发LED告警（若硬件支持）或串口循环提示。 |
| 3. HTTP视频服务  | 1. 搭建HTTP服务（端口80，冲突时自动切换为8080）；<br>2. 浏览器访问`http://ESP32_IP`时，推送`multipart/x-mixed-replace`格式视频流；<br>3. 支持单帧截图（访问`http://ESP32_IP/snapshot`时返回当前JPEG帧）。 |
| 4. 内网穿透适配  | 1. 支持Sakura Frp/花生壳（免费版），适配TCP端口映射（本地80/8080→公网随机端口）；<br>2. 穿透隧道断开后，工具自动重连（依赖工具原生功能）；<br>3. 公网访问地址可通过串口日志配置（无需修改代码重新烧录）。 |
| 5. MQTT远程控制  | 1. 连接公共MQTT服务器（如test.mosquitto.org:1883），订阅主题`esp32/camera/control`；<br>2. 支持指令：<br>   - `take_picture`：保存当前帧到TF卡（若插入），并返回文件路径；<br>   - `camera_on`/`camera_off`：开启/关闭摄像头（关闭时降低功耗）；<br>3. 执行指令后，向主题`esp32/camera/reply`推送结果（如`{"status":"success","file":"snap_20241006.jpg"}`）。 |
| 6. 低功耗基础    | 1. 摄像头关闭时，ESP32进入浅度休眠（电流≤50mA）；<br>2. 无网络连接时，降低WiFi扫描频率（每10秒扫描1次，减少功耗）。 |


## 4. 非功能需求（补充核心场景指标，贴合实际限制）
| 类别         | 要求（可量化、可验证）                                                                 |
|--------------|----------------------------------------------------------------------------------------|
| 性能         | 1. 视频流延迟：局域网内≤1秒，内网穿透后≤3秒（免费工具带宽限制）；<br>2. MQTT指令响应：从发送到执行≤2秒；<br>3. 内存占用：单帧JPEG（VGA）存储≤100KB，总内存占用≤300KB（预留PSRAM给其他模块）。 |
| 兼容性       | 1. 开发环境：兼容ESP-IDF v5.5，支持VSCode（ESP-IDF插件v1.6.0+）；<br>2. 穿透工具：兼容Sakura Frp v0.46.0+、花生壳v6.0+；<br>3. 客户端：支持Chrome/Safari浏览器（访问视频流）、MQTT.fx/v3.0+（发送指令）。 |
| 可靠性       | 1. 连续运行：局域网内稳定运行≥24小时无崩溃，内网穿透下≥12小时无断流；<br>2. 异常恢复：WiFi断连后30秒内重连成功率≥95%，穿透隧道断开后工具自动重连恢复时间≤1分钟；<br>3. 数据完整性：MQTT指令丢失率≤5%（网络稳定时）。 |
| 功耗         | 1. 正常工作（视频流+WiFi）：电流≤200mA（USB 5V供电）；<br>2. 摄像头关闭（浅度休眠）：电流≤50mA；<br>3. 无网络（待机）：电流≤30mA。 |
| 可维护性     | 1. 代码模块化：核心功能（WiFi/摄像头/MQTT）拆分独立.c/.h文件，接口注释覆盖率≥90%；<br>2. 日志清晰：每个模块用独立TAG（如wifi_init、mqtt_ctrl），错误日志含错误码（如esp_err_to_name()）；<br>3. 文档配套：包含需求文档、调试日志（30+问题记录）、接口文档（HTTP/MQTT API）。 |


## 5. 验收标准（对应功能/非功能，明确测试方法）
| 需求项                 | 验收方法及指标                                                                 |
|------------------------|--------------------------------------------------------------------------------|
| 摄像头采集             | 1. 烧录代码后，串口打印“camera init success”，JPEG帧首字节为0xFF 0xD8 0xFF；<br>2. 浏览器访问`http://ESP32_IP`，连续观看5分钟，画面无花屏、卡顿（帧率≥8fps）。 |
| WiFi网络               | 1. 输入错误WiFi密码，串口打印“retry to connect to the AP”（重试5次后提示失败）；<br>2. 正常连接后，断开路由器再恢复，30秒内重连成功，串口打印新IP。 |
| HTTP视频服务           | 1. 局域网内2台设备同时访问`http://ESP32_IP`，均能正常显示视频流（延迟≤1秒）；<br>2. 访问`http://ESP32_IP/snapshot`，浏览器能下载JPEG图片（大小≤100KB）。 |
| 内网穿透适配           | 1. 配置Sakura Frp映射本地80端口，手机用4G网络访问公网地址（如tcp://abc.sakura.frp.work:12345），视频流显示正常（延迟≤3秒）；<br>2. 断开电脑网络再恢复，穿透隧道1分钟内自动重连，手机可重新访问。 |
| MQTT远程控制           | 1. 用MQTT.fx发送`take_picture`指令到`esp32/camera/control`，10秒内收到`esp32/camera/reply`的成功响应，TF卡（若插入）能找到对应截图文件；<br>2. 发送100次`camera_on/off`指令，响应成功≥90次，无设备崩溃。 |
| 低功耗基础             | 1. 用万用表测摄像头关闭时的电流，连续3次测量均≤50mA；<br>2. 无网络时，测电流≤30mA，串口每10秒打印1次“WiFi scanning...”。 |
| 代码可维护性           | 1. 检查代码目录，WiFi（wifi.c）、摄像头（camera.c）、MQTT（mqtt_ctrl.c）模块独立；<br>2. 随机查看5个接口函数（如wifi_init()、mqtt_send_cmd()），均有完整注释（功能、参数、返回值）。 |