# ESP32-CAM 轻量监控系统需求文档
**版本**：v1.0  
**日期**：2025-10-05  
**修改记录**：  
- v1.0：基于硬件实际参数，完成局域网实时视频核心功能适配，覆盖OV2640/OV7670摄像头、4M PSRAM等硬件特性，包含性能指标及调试问题记录  


## 1. 项目概述
### 1.1 项目背景与意义
当前校园和租房场景中，轻量监控需求（如查看实验室3D打印机状态、租房内安全情况）逐渐增加，但商用监控设备存在成本高（需额外购买硬件和云服务）、部署复杂的问题。  
本项目基于ESP32 - CAM开发板（已有的硬件资源，无额外成本），实现低成本、易部署的远程监控系统，支持局域网实时查看和公网访问，既能满足实际监控需求，又能积累嵌入式开发（硬件驱动+网络通信）的实战经验，为实习简历补充完整项目案例。

### 1.2 目标用户与场景
| 目标用户       | 核心使用场景                                                                 |
|----------------|------------------------------------------------------------------------------|
| 学生群体       | 宿舍安防（远程查看是否有陌生人进入）、实验室设备监控（如3D打印机是否完成打印） |
| 租房用户       | 出门后通过手机查看家中门窗状态、宠物活动（无需复杂配置，连接WiFi即可使用）     |
| 嵌入式学习者   | 作为实战案例，掌握ESP32外设驱动（摄像头、WiFi）、HTTP视频流、内网穿透等技术   |


## 2. 功能需求
### 2.1 核心功能（当前版本必须实现）
| 功能模块         | 具体需求描述（要可操作、可验证）                                                                 |
|------------------|-------------------------------------------------------------------------------------------------|
| 摄像头视频采集   | 1. 适配OV2640摄像头，输出JPEG格式视频流（方便网络传输）；<br>2. 分辨率固定为640x480（VGA，平衡清晰度和带宽）；<br>3. 帧率≥8fps（保证画面流畅）；<br>4. 初始化失败时，串口打印错误日志（如“camera init failed: timeout”）。 |
| WiFi连接管理     | 1. 支持STA模式，连接指定WiFi（SSID和密码可在代码中配置）；<br>2. 断连后自动重连（最多重试5次，间隔3秒/次）；<br>3. 连接成功后，串口打印局域网IP（如“IP: 192.168.1.100”）。 |
| HTTP视频服务     | 1. 启动HTTP服务器（默认端口80）；<br>2. 浏览器访问`http://IP地址`时，能实时显示视频流；<br>3. 支持至少2台设备同时访问（满足多人查看需求）。 |

### 2.2 扩展功能（后续版本可实现，体现迭代思维）
| 功能模块         | 具体需求描述                                                                 |
|------------------|------------------------------------------------------------------------------|
| 内网穿透         | 通过Sakura Frp工具，实现公网访问视频流（手机4G网络可查看）                   |
| 远程截图         | 访问`http://IP地址/snapshot`时，保存当前画面为JPEG图片（存到TF卡）           |
| MQTT控制         | 接收“开启/关闭摄像头”指令（通过MQTT协议），关闭时降低功耗                     |


## 3. 性能需求 具体怎么测量，万用表、示波器等工具
| 性能指标         | 目标值（可实现、可测试）                          | 测试方法（怎么验证达标）                                                                 |
|------------------|---------------------------------------------------|----------------------------------------------------------------------------------------|
| 视频延迟         | 局域网内≤1秒，公网（扩展后）≤3秒                  | 用手机拍摄ESP32摄像头画面，同时在浏览器看视频，对比两者的时间差                           |
| 稳定性           | 连续运行≥24小时无崩溃、无断流                     | 通电后持续运行24小时，检查串口日志无异常重启，浏览器画面无中断                           |
| 内存占用         | 单帧JPEG数据≤100KB（避免PSRAM不足）               | 代码中打印每帧数据大小，连续100帧均不超过100KB                                          |
| 功耗（扩展）     | 摄像头工作时电流≤200mA，关闭时≤50mA               | 用万用表串联在供电回路中，测量不同状态下的电流值                                         |


## 4. 约束条件
### 4.1 硬件限制
| 硬件参数         | 限制描述                                                                 | 应对措施（体现解决问题的思路）                                                       |
|------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------------------|
| ESP32 - CAM资源  | 内存：520KB内部RAM + 4M PSRAM；CPU：双核240MHz（算力有限）                | 1. 用PSRAM存储视频帧（不占用内部RAM）；<br>2. 单线程处理视频流（避免多任务切换开销） |
| 摄像头供电       | OV2640工作时峰值电流≥150mA，电脑USB口供电可能不足                         | 必须用≥1A的电源适配器供电（避免初始化失败）                                           |

### 4.2 网络限制
| 网络条件         | 限制描述                                                                 | 应对措施                                                                             |
|------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------------------|
| WiFi频段         | ESP32仅支持2.4GHz（不支持5GHz）                                          | 连接WiFi时需选择2.4GHz热点                                                           |
| 公网带宽（扩展） | 免费内网穿透工具（如Sakura Frp）带宽≤1Mbps                               | 降低视频帧率至5fps（平衡流畅度和带宽）                                                |

### 4.3 成本限制
- 无额外硬件支出：基于现有ESP32 - CAM开发板，不购买新传感器或服务器；
- 软件工具免费：使用ESP - IDF（开源）、免费内网穿透工具、公共MQTT服务器。


## 5. 调试问题记录（持续更新）
| 问题描述                | 发生场景                | 解决方案                                                                 | 验证结果                     |
|-------------------------|-------------------------|--------------------------------------------------------------------------|------------------------------|
| 摄像头初始化失败（超时） | 上电启动时，串口报错    | 1. 降低摄像头时钟频率（xclk从20MHz改为10MHz）；<br>2. 更换1A电源适配器   | 初始化成功率从60%提升至100%   |
| 视频流画面花屏          | 浏览器访问时画面撕裂    | 1. 代码中增加JPEG帧校验（检查开头0xFF 0xD8）；<br>2. 丢弃无效帧并重试   | 花屏概率从30%降至0           |
| WiFi频繁断连            | 距离路由器5米以上时     | 1. 监听WiFi断开事件（WIFI_EVENT_STA_DISCONNECTED）；<br>2. 触发自动重连 | 断连后30秒内重连成功率≥95%   |